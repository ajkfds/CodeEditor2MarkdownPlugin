<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>Markdown Preview</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 2rem;
            background-color: #f6f8fa;
        }

        #preview {
            padding: 1rem 2rem;
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        pre {
            background: #f6f8fa;
            padding: 0.8rem;
            border-radius: 4px;
            overflow-x: auto;
        }

        table {
            border-collapse: collapse;
            margin: 1em 0;
        }

        th, td {
            border: 1px solid #d0d7de;
            padding: 0.4em 0.8em;
        }

        th {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>
    <h2>Markdown Preview</h2>
    <div id="preview">Loading...</div>

    <!-- Marked (Markdown parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ✅ Mermaid (UMD版を使用) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- WaveDrom -->
    <script src="https://wavedrom.com/skins/default.js"></script>
    <script src="https://wavedrom.com/wavedrom.min.js"></script>

    <script>
        // Mermaid初期化
        mermaid.initialize({
            startOnLoad: false,
            theme: "default"
        });

        // Markdown→HTML変換
        function loadMarkdownContent(content) {
            marked.setOptions({
                gfm: true,
                breaks: false,
                tables: true
            });

            const html = marked.parse(content);
            const preview = document.getElementById('preview');
            preview.innerHTML = html;

            // Mermaid & WaveDrom レンダリング
            renderMermaid(preview);
            renderWaveDrom(preview);
        }

        // ```mermaid``` コードブロックを描画
        function renderMermaid(root) {
            const blocks = root.querySelectorAll('code.language-mermaid');
            blocks.forEach((block, i) => {
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = block.textContent;
                block.parentNode.replaceWith(div);
            });
            // Mermaidを再走査して描画
            mermaid.run({ querySelector: ".mermaid" });
        }

        // ```wavedrom``` コードブロックを描画
        function renderWaveDrom(root) {
            const blocks = root.querySelectorAll('code.language-wavedrom');
            blocks.forEach((block, i) => {
                const script = document.createElement('script');
                script.type = 'WaveDrom';
                script.textContent = block.textContent;
                block.parentNode.replaceWith(script);
            });
            if (window.WaveDrom) WaveDrom.ProcessAll();
        }
    </script>
</body>
</html>
